{% extends 'core/base.html' %}
{% load static %}

{% block title %}My Request - DisasterBridge{% endblock %}

{% block content %}


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Requests - DisasterBridge</title>

    <!-- Bootstrap & Leaflet -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body style="background-color:#f9f9f9;">



    <!-- Requests Table -->
    <div class="container mt-5">
        <h2 class="mb-4 text-center">ðŸ“‹ My Requests</h2>

        {% if requests %}
            {% for req in requests %}
                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <h5><strong>Request ID:</strong> {{ req.pk }}</h5>
                        <p><strong>Location:</strong> {{ req.location }}</p>
                        <p><strong>Category:</strong> {{ req.category }}</p>
                        <p><strong>Urgency:</strong> {{ req.urgency }}</p>
                        <p><strong>Date:</strong> {{ req.created_at|date:"Y-m-d H:i" }}</p>
                        <p><strong>Status:</strong> {{ req.status }}</p>

                        <div id="map_{{ req.pk }}" style="height:200px; border-radius:8px;"></div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info text-center">No requests found.</div>
        {% endif %}
    </div>



    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        {% for req in requests %}
        (function() {
            const containerId = "map_{{ req.pk }}";
            const location = "{{ req.location|escapejs }}";
            const map = L.map(containerId).setView([23.8103, 90.4125], 10);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);

            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${location}`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const lat = data[0].lat;
                        const lon = data[0].lon;
                        L.marker([lat, lon]).addTo(map);
                        map.setView([lat, lon], 12);
                    }
                });
        })();
        {% endfor %}
    });
    </script>
</body>
</html>

{% endblock %}